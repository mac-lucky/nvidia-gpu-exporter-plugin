Menu="Utilities"
Title="Nvidia GPU Exporter"
Icon="nvidia_gpu_exporter.png"
---
<?php
$service_running = shell_exec("/usr/local/emhttp/plugins/nvidia_gpu_exporter/include/service.sh status");
$service_status = trim($service_running) == "running" ? true : false;

// Check if binary exists
$binary_exists = file_exists("/usr/local/bin/nvidia_gpu_exporter");

// Check if nvidia-smi is available
$nvidia_smi_available = !empty(shell_exec("which nvidia-smi 2>/dev/null"));

// Check if nvidia-smi works
$nvidia_smi_works = false;
if ($nvidia_smi_available) {
    $nvidia_test = shell_exec("nvidia-smi 2>/dev/null");
    $nvidia_smi_works = !empty($nvidia_test) && strpos($nvidia_test, 'NVIDIA-SMI') !== false;
}

// Get log file content for troubleshooting
$log_content = '';
$log_file = '/var/log/nvidia_gpu_exporter.log';
if (file_exists($log_file)) {
    $log_lines = file($log_file);
    $log_content = implode('', array_slice($log_lines, -10)); // Last 10 lines
}

// Get configuration
$config_file = "/boot/config/plugins/nvidia_gpu_exporter/settings.cfg";
$config = parse_ini_file($config_file, false, INI_SCANNER_RAW) ?: [];
$port = $config['port'] ?? '9835';
$log_level = $config['log_level'] ?? 'info';
$autostart = $config['autostart'] ?? 'yes';

// Handle form submissions
if (isset($_POST['action'])) {
    switch ($_POST['action']) {
        case 'start':
            $start_output = shell_exec("/usr/local/emhttp/plugins/nvidia_gpu_exporter/include/service.sh start 2>&1");
            break;
        case 'stop':
            shell_exec("/usr/local/emhttp/plugins/nvidia_gpu_exporter/include/service.sh stop");
            break;
        case 'restart':
            shell_exec("/usr/local/emhttp/plugins/nvidia_gpu_exporter/include/service.sh restart");
            break;
        case 'download_binary':
            $download_output = shell_exec("/usr/local/emhttp/plugins/nvidia_gpu_exporter/include/download.sh download 2>&1");
            break;
        case 'troubleshoot':
            $troubleshoot_output = shell_exec("/usr/local/emhttp/plugins/nvidia_gpu_exporter/include/troubleshoot.sh 2>&1");
            break;
        case 'save_config':
            $new_port = $_POST['port'] ?? '9835';
            $new_log_level = $_POST['log_level'] ?? 'info';
            $new_autostart = $_POST['autostart'] ?? 'yes';
            
            $config_content = "port=$new_port\n";
            $config_content .= "log_level=$new_log_level\n";
            $config_content .= "autostart=$new_autostart\n";
            
            file_put_contents($config_file, $config_content);
            
            // Restart service if running to apply new settings
            if ($service_status) {
                shell_exec("/usr/local/emhttp/plugins/nvidia_gpu_exporter/include/service.sh restart");
            }
            break;
    }
    // Refresh page to show updated status
    echo '<script>setTimeout(function(){ window.location.reload(); }, 1000);</script>';
    exit;
}
?>

<script>
function submitAction(action) {
    var form = document.createElement('form');
    form.method = 'POST';
    form.style.display = 'none';
    
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'action';
    input.value = action;
    
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

function saveConfig() {
    document.getElementById('configForm').submit();
}
</script>

<style>
.service-status {
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    font-weight: bold;
}
.running {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.stopped {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.button-group {
    margin: 10px 0;
}
.button-group button {
    margin-right: 10px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}
.btn-primary {
    background-color: #007bff;
    color: white;
}
.btn-success {
    background-color: #28a745;
    color: white;
}
.btn-danger {
    background-color: #dc3545;
    color: white;
}
.btn-warning {
    background-color: #ffc107;
    color: black;
}
.config-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin: 15px 0;
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: inline-block;
    width: 120px;
    font-weight: bold;
}
.form-group input, .form-group select {
    width: 200px;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
}
</style>

<h1><span style="color: #76B900;">Nvidia GPU Exporter</span></h1>

<div class="service-status <?php echo $service_status ? 'running' : 'stopped'; ?>">
    Service Status: <?php echo $service_status ? 'Running' : 'Stopped'; ?>
    <?php if ($service_status): ?>
        - Metrics available at <a href="http://<?php echo $_SERVER['HTTP_HOST']; ?>:<?php echo $port; ?>/metrics" target="_blank">http://<?php echo $_SERVER['HTTP_HOST']; ?>:<?php echo $port; ?>/metrics</a>
    <?php endif; ?>
</div>

<!-- Diagnostic Information -->
<?php if (!$binary_exists || !$nvidia_smi_available || !$nvidia_smi_works): ?>
<div style="background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0;">
    <h4>⚠️ System Requirements Check:</h4>
    <ul>
        <li>Binary exists: <?php echo $binary_exists ? '✅ Yes' : '❌ No'; ?></li>
        <li>nvidia-smi available: <?php echo $nvidia_smi_available ? '✅ Yes' : '❌ No'; ?></li>
        <li>nvidia-smi working: <?php echo $nvidia_smi_works ? '✅ Yes' : '❌ No'; ?></li>
    </ul>
    
    <?php if (!$binary_exists): ?>
        <p><strong>Missing Binary:</strong> The nvidia_gpu_exporter binary is not installed.</p>
        <button class="btn-primary" onclick="submitAction('download_binary')">Download Binary</button>
    <?php endif; ?>
    
    <?php if (!$nvidia_smi_available || !$nvidia_smi_works): ?>
        <p><strong>Nvidia Driver Issue:</strong> Please ensure Nvidia drivers are properly installed and working.</p>
    <?php endif; ?>
</div>
<?php endif; ?>

<!-- Show startup output if available -->
<?php if (isset($start_output) && !empty($start_output)): ?>
<div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; margin: 10px 0;">
    <h4>Service Start Output:</h4>
    <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;"><?php echo htmlspecialchars($start_output); ?></pre>
</div>
<?php endif; ?>

<!-- Show download output if available -->
<?php if (isset($download_output) && !empty($download_output)): ?>
<div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; margin: 10px 0;">
    <h4>Download Output:</h4>
    <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;"><?php echo htmlspecialchars($download_output); ?></pre>
</div>
<?php endif; ?>

<!-- Show troubleshoot output if available -->
<?php if (isset($troubleshoot_output) && !empty($troubleshoot_output)): ?>
<div style="background-color: #e7f3ff; border: 1px solid #b8daff; padding: 10px; border-radius: 5px; margin: 10px 0;">
    <h4>Troubleshoot Results:</h4>
    <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"><?php echo htmlspecialchars($troubleshoot_output); ?></pre>
</div>
<?php endif; ?>

<!-- Show log content if service failed to start -->
<?php if (!$service_status && !empty($log_content)): ?>
<div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; margin: 10px 0;">
    <h4>Recent Log Entries:</h4>
    <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"><?php echo htmlspecialchars($log_content); ?></pre>
</div>
<?php endif; ?>

<div class="button-group">
    <?php if ($service_status): ?>
        <button class="btn-danger" onclick="submitAction('stop')">Stop Service</button>
        <button class="btn-warning" onclick="submitAction('restart')">Restart Service</button>
    <?php else: ?>
        <button class="btn-success" onclick="submitAction('start')">Start Service</button>
    <?php endif; ?>
    <button class="btn-primary" onclick="submitAction('troubleshoot')">Run Diagnostics</button>
</div>

<div class="config-section">
    <h3>Configuration</h3>
    <form id="configForm" method="POST">
        <input type="hidden" name="action" value="save_config">
        
        <div class="form-group">
            <label for="port">Port:</label>
            <input type="number" id="port" name="port" value="<?php echo htmlspecialchars($port); ?>" min="1" max="65535">
        </div>
        
        <div class="form-group">
            <label for="log_level">Log Level:</label>
            <select id="log_level" name="log_level">
                <option value="debug" <?php echo $log_level == 'debug' ? 'selected' : ''; ?>>Debug</option>
                <option value="info" <?php echo $log_level == 'info' ? 'selected' : ''; ?>>Info</option>
                <option value="warn" <?php echo $log_level == 'warn' ? 'selected' : ''; ?>>Warning</option>
                <option value="error" <?php echo $log_level == 'error' ? 'selected' : ''; ?>>Error</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="autostart">Auto Start:</label>
            <select id="autostart" name="autostart">
                <option value="yes" <?php echo $autostart == 'yes' ? 'selected' : ''; ?>>Yes</option>
                <option value="no" <?php echo $autostart == 'no' ? 'selected' : ''; ?>>No</option>
            </select>
        </div>
        
        <button type="button" class="btn-primary" onclick="saveConfig()">Save Configuration</button>
    </form>
</div>

<div style="margin-top: 20px;">
    <h3>About</h3>
    <p>The Nvidia GPU Exporter provides Prometheus metrics for Nvidia GPUs, including:</p>
    <ul>
        <li>GPU utilization</li>
        <li>Memory usage</li>
        <li>Temperature</li>
        <li>Power consumption</li>
        <li>Fan speed</li>
        <li>Process information</li>
    </ul>
    <p>For more information, visit the <a href="https://github.com/utkuozdemir/nvidia_gpu_exporter" target="_blank">project page</a>.</p>
</div>
