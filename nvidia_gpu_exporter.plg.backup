<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
  <!ENTITY name      "nvidia_gpu_exporter">
  <!ENTITY author    "mac-lucky">
  <!ENTITY version   "1.0.0">
  <!ENTITY launch    "Settings/nvidia_gpu_exporter">
  <!ENTITY gitURL    "https://github.com/mac-lucky/nvidia-gpu-exporter-plugin">
  <!ENTITY pluginURL "https://raw.githubusercontent.com/mac-lucky/nvidia-gpu-exporter-plugin/main/nvidia_gpu_exporter.plg">
  <!ENTITY md5       "3bed7ba4f56e37c2a7a66f3be9ce699b">
  <!ENTITY packages  "/boot/config/plugins/&name;/packages">
  <!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN  name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" min="6.9.0" support="https://github.com/mac-lucky/nvidia-gpu-exporter-plugin/issues">

<CHANGES>

###2025.08.16
- Initial release
- Nvidia GPU Exporter for Prometheus monitoring
- Start/Stop/Restart controls via web interface
- Configurable port, log level, and autostart options
- Based on utkuozdemir/nvidia_gpu_exporter v1.2.8

</CHANGES>

<FILE Run="/bin/bash">
<INLINE>
# Remove old plugin packages
rm -f $(ls /boot/config/plugins/&name;/&name;*.txz 2>/dev/null|grep -v '&version;')

# Create plugin directories
mkdir -p /boot/config/plugins/&name;
mkdir -p /usr/local/bin

# Download nvidia_gpu_exporter binary if not present
if [ ! -f /usr/local/bin/nvidia_gpu_exporter ]; then
  echo "Downloading nvidia_gpu_exporter binary..."
  wget -O /tmp/nvidia_gpu_exporter.tar.gz https://github.com/utkuozdemir/nvidia_gpu_exporter/releases/download/v1.2.8/nvidia_gpu_exporter_1.2.8_linux_x86_64.tar.gz
  cd /tmp
  tar -xzf nvidia_gpu_exporter.tar.gz
  cp nvidia_gpu_exporter /usr/local/bin/
  chmod +x /usr/local/bin/nvidia_gpu_exporter
  rm -f nvidia_gpu_exporter.tar.gz nvidia_gpu_exporter README.md LICENSE
  echo "nvidia_gpu_exporter binary installed"
fi
</INLINE>
</FILE>

<FILE Name="/boot/config/plugins/&name;/&name;-&version;.txz" Run="upgradepkg --install-new">
<URL>&gitURL;/releases/download/&version;/&name;-&version;.txz</URL>
<MD5>&md5;</MD5>
</FILE>

<FILE Name="&emhttp;/README.md">
<INLINE>
**Nvidia GPU Exporter**

This plugin provides Prometheus metrics for Nvidia GPUs using the nvidia_gpu_exporter.
It exposes GPU utilization, memory usage, temperature, and other metrics for monitoring.

The exporter runs on port 9835 by default and provides metrics at /metrics endpoint.

Requirements:
- Nvidia GPU with drivers installed
- nvidia-smi working correctly

Access the plugin at Tools > Nvidia GPU Exporter to start/stop the service.
</INLINE>
</FILE>

</PLUGIN>